const GRID_SIZE=5,PANEL_RATIO=.7;let previousOverlay=null;const SEGMENTS={a:1,b:2,c:4,d:8,e:16,f:32,g:64};function saveGame(e=null){const t={level:e||gameState.level,petrifiedPositions:gameState.petrifiedPositions};try{localStorage.setItem("timemachine_save",JSON.stringify(t))}catch(e){}}function loadGame(){try{const e=localStorage.getItem("timemachine_save");if(!e)return null;return JSON.parse(e)}catch(e){return null}}function clearSave(){try{localStorage.removeItem("timemachine_save")}catch(e){}}function loadCheckpoint(){try{const e=localStorage.getItem("timemachine_checkpoint");return e?parseInt(e):0}catch(e){return 0}}function saveCheckpoint(e){try{return e>loadCheckpoint()&&(localStorage.setItem("timemachine_checkpoint",e.toString()),!0)}catch(e){return!1}}function isLevel3Done(){return!!localStorage.getItem("timemachine_level3done")}function markLevel3Done(){localStorage.setItem("timemachine_level3done","1")}function loadTutorialProgress(){try{const e=localStorage.getItem("timemachine_tutorials");return e?JSON.parse(e):{tut01:!1,tut02:!1,tut03:!1,tut04:!1}}catch(e){return{tut01:!1,tut02:!1,tut03:!1,tut04:!1}}}function isTutorialSeen(e){return!0===loadTutorialProgress()[e]}function markTutorialSeen(e){try{const t=loadTutorialProgress();t[e]=!0,localStorage.setItem("timemachine_tutorials",JSON.stringify(t))}catch(e){}}let gameState={level:1,grid:Array(25).fill(null),targetPanels:[],completedTargets:[!1,!1,!1,!1],panelPool:[],timerInterval:null,timerDuration:5e3,timerRemaining:5e3,isIntroSequence:!1,petrifiedPositions:[],isRefilling:!1,introInterval:null,refillInterval:null};function createPanelElement(e){const t=document.createElement("div");t.className="led-panel",t.style.position="relative",t.style.width="100%",t.style.aspectRatio=.7;const a=document.createElement("img");a.src="assets/panel_bg.svg",a.style.position="absolute",a.style.width="100%",a.style.height="100%",a.style.top="0",a.style.left="0",t.appendChild(a);return["a","b","c","d","e","f","g"].forEach((a,n)=>{if(e&1<<n){const e=document.createElement("img");e.src=`assets/seg_${a}.svg`,e.className=`segment seg-${a}`,e.style.position="absolute",e.style.width="100%",e.style.height="100%",e.style.top="0",e.style.left="0",e.style.pointerEvents="none",t.appendChild(e)}}),t.dataset.segments=e,t}const testPanel=createPanelElement(DIGITS[8]);function renderGrid(){for(let e=0;e<25;e++)null!==gameState.grid[e]?addPanelToCell(e,gameState.grid[e]):removePanelFromCell(e)}function initGrid(){const e=document.getElementById("game-grid");e.innerHTML="";for(let t=0;t<25;t++){const a=document.createElement("div");a.className="grid-cell",a.dataset.index=t,a.style.backgroundColor="#1a1a1a",a.style.clipPath="polygon(11.43% 0%, 88.57% 0%, 100% 8%, 100% 92%, 88.57% 100%, 11.43% 100%, 0% 92%, 0% 8%)",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.position="relative",e.appendChild(a)}attachGridListeners()}function addPanelToCell(e,t){const a=document.querySelector(`.grid-cell[data-index="${e}"]`);if(!a)return;a.innerHTML="";const n=createPanelElement(t);n.style.width="96%",n.style.height="96%",isPetrified(e)&&(n.style.filter="grayscale(100%) sepia(100%) hue-rotate(-50deg) saturate(300%)",n.style.opacity="0.7",n.classList.add("petrified")),a.appendChild(n)}function removePanelFromCell(e){const t=document.querySelector(`.grid-cell[data-index="${e}"]`);t&&(t.innerHTML="")}function addPanelToGrid(e){const t=[];for(let e=0;e<gameState.grid.length;e++)null===gameState.grid[e]&&t.push(e);if(0===t.length)return showGameOverOverlay(),!1;const a=t[Math.floor(Math.random()*t.length)];return gameState.grid[a]=e,addPanelToCell(a,e),!0}function renderTargetRow(){for(let e=0;e<4;e++){const t=document.getElementById(`target-${e}`);t.innerHTML="",t.style.width="60px",t.style.aspectRatio=.7,t.style.backgroundColor="#1a1a1a",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.position="relative";const a=createPanelElement(gameState.targetPanels[e]);if(a.style.width="95%",a.style.height="96%",a.style.opacity="0.3",a.style.filter="grayscale(100%)",t.appendChild(a),gameState.completedTargets[e]){const a=createPanelElement(gameState.targetPanels[e]);a.style.position="absolute",a.style.top="50%",a.style.left="50%",a.style.transform="translate(-50%, -50%)",t.appendChild(a)}}}function playIntroSequence(){let e;gameState.isIntroSequence=!0,e=1===gameState.level?2:2===gameState.level?1:3!==gameState.level||isLevel3Done()?4:1;const t=document.getElementById("add-button");t.disabled=!0,t.style.opacity="0.5",t.style.cursor="not-allowed";let a=0;gameState.introInterval=setInterval(()=>{if(a<e){addPanelToGrid(getPanelFromPool()),a++}else{if(clearInterval(gameState.introInterval),gameState.introInterval=null,gameState.isIntroSequence=!1,t.disabled=!1,t.style.opacity="1",t.style.cursor="pointer",gameState.targetPanels.includes(127)){const e=gameState.targetPanels.filter((e,t)=>127===e&&gameState.completedTargets[t]).length,t=gameState.petrifiedPositions.filter(e=>127===gameState.grid[e]);for(let a=0;a<e&&a<t.length;a++){const e=t[a];gameState.grid[e]=null,gameState.petrifiedPositions=gameState.petrifiedPositions.filter(t=>t!==e)}e>0&&(renderTargetRow(),renderGrid())}startTimer(),setTimeout(()=>{1===gameState.level?showTutorial("tut01"):2===gameState.level?showTutorial("tut02"):3===gameState.level&&showTutorial("tut03")},200)}},100)}function fulfillPetrifiedEights(){if(!gameState.targetPanels.includes(127))return;[...gameState.petrifiedPositions].forEach(e=>{const t=gameState.targetPanels.findIndex((e,t)=>127===e&&!gameState.completedTargets[t]);-1!==t&&(gameState.completedTargets[t]=!0)})}function initLevel(e){stopTimer(),gameState.introInterval&&(clearInterval(gameState.introInterval),gameState.introInterval=null),gameState.refillInterval&&(clearInterval(gameState.refillInterval),gameState.refillInterval=null),gameState.isIntroSequence=!1,gameState.isRefilling=!1;const t=LEVELS.find(t=>t.levelNumber===e);if(!t)return;gameState.level=e,gameState.targetPanels=t.targetPanels,gameState.completedTargets=[!1,!1,!1,!1],gameState.timerDuration=t.timerDuration,gameState.timerRemaining=t.timerDuration,document.getElementById("add-button").style.setProperty("--timer-width","0%");const a=[...gameState.grid];if(gameState.grid=Array(25).fill(null),gameState.petrifiedPositions.forEach(e=>{gameState.grid[e]=a[e]}),t.checkpoint){saveCheckpoint(e)}fulfillPetrifiedEights();const n=t.allowedOperations;gameState.panelPool=generatePool(n),renderGrid(),renderTargetRow();document.getElementById("add-button").style.visibility=isTutorialSeen("tut03")||e>=4?"visible":"hidden",playIntroSequence()}initGrid();let loadUnlockTime=0,loadedLevel=1;renderGrid();const savedGame=loadGame();if(savedGame){gameState.petrifiedPositions=savedGame.petrifiedPositions,gameState.petrifiedPositions.forEach(e=>{gameState.grid[e]=127}),loadedLevel=savedGame.level;document.getElementById("load-overlay").style.display="flex",loadUnlockTime=Date.now()+300}else{document.getElementById("intro-overlay").style.display="flex"}function handleAddButton(){if(gameState.isIntroSequence)return;0===gameState.panelPool.length&&regeneratePool();addPanelToGrid(getPanelFromPool())&&resetTimer()}function notOperation(e){return 127^e}function orOperation(e,t){return e|t}function checkAndRefillGrid(){if(gameState.isIntroSequence||gameState.isRefilling)return;gameState.grid.every((e,t)=>null===e||gameState.petrifiedPositions.includes(t))&&refillGrid()}function refillGrid(){let e;gameState.isRefilling=!0,e=1===gameState.level?2:2===gameState.level?1:3!==gameState.level||isLevel3Done()?4:2,stopTimer();const t=document.getElementById("add-button");t.disabled=!0,t.style.opacity="0.5",t.style.cursor="not-allowed";let a=0;gameState.refillInterval=setInterval(()=>{if(a<e){0===gameState.panelPool.length&&regeneratePool();addPanelToGrid(getPanelFromPool()),a++}else clearInterval(gameState.refillInterval),gameState.refillInterval=null,gameState.isRefilling=!1,t.disabled=!1,t.style.opacity="1",t.style.cursor="pointer",startTimer()},100)}function animateTargetCompletion(e,t){const a=document.querySelector(`[data-index="${e}"]`);if(!a)return;const n=a.querySelector(".led-panel");n&&(n.classList.add("panel-non-interactive"),n.classList.add("panel-brightening"),setTimeout(()=>{n.classList.add("panel-fading"),setTimeout(()=>{gameState.grid[e]=null,renderGrid(),gameState.completedTargets[t]=!0,animateTargetPanelAppearance(t),setTimeout(()=>{checkVictory();gameState.completedTargets.every(e=>!0===e)||resetTimer(),checkAndRefillGrid()},200)},100)},100))}function animateTargetPanelAppearance(e){const t=document.getElementById("target-row").querySelectorAll(".target-panel")[e];if(!t)return;t.innerHTML="";const a=createPanelElement(gameState.targetPanels[e]);a.classList.add("target-panel-appearing"),t.appendChild(a),setTimeout(()=>{a.classList.remove("target-panel-appearing"),a.classList.add("target-panel-normal")},10)}function checkTargetMatch(e){const t=gameState.grid[e];if(null===t)return!1;for(let a=0;a<gameState.targetPanels.length;a++){if(t===gameState.targetPanels[a]&&!gameState.completedTargets[a])return animateTargetCompletion(e,a),!0}return!1}function playLevelTransition(e){const t=document.getElementById("level-transition"),a=document.getElementById("add-button"),n=document.getElementById("pause-button"),l=document.getElementById("game-grid");t.style.display="block",a.style.display="none",n.style.display="none",l.style.display="none",setTimeout(()=>{t.classList.add("fade-in")},10),setTimeout(()=>{t.classList.remove("fade-in"),setTimeout(()=>{t.style.display="none",a.style.display="block",n.style.display="block",l.style.display="grid",e&&e()},300)},1300)}function checkVictory(){if(gameState.completedTargets.every(e=>!0===e)){stopTimer();const e=gameState.level+1;LEVELS.find(t=>t.levelNumber===e)?(3===gameState.level&&markLevel3Done(),saveGame(e),playLevelTransition(()=>{initLevel(e)})):showVictoryOverlay()}}function handlePanelClick(e){if(gameState.isRefilling)return;const t=2===gameState.level?"tut02":"tut03";if(gameState.level<4&&!isTutorialSeen(t))return;if(null===gameState.grid[e])return;if(isPetrified(e))return;const a=notOperation(gameState.grid[e]);gameState.grid[e]=a,renderGrid(),checkTargetMatch(e),checkAndPetrifyEight(e)}function checkAndPetrifyEight(e){if(127===gameState.grid[e]){const t=[];gameState.targetPanels.forEach((e,a)=>{127===e&&t.push(a)});0!==t.filter(e=>!gameState.completedTargets[e]).length||gameState.petrifiedPositions.includes(e)||(gameState.petrifiedPositions.push(e),saveGame(gameState.level),setTimeout(()=>{showTutorial("tut04")},500),renderGrid())}}function isPetrified(e){return gameState.petrifiedPositions.includes(e)}function attachGridListeners(){document.querySelectorAll(".grid-cell").forEach(e=>{const t=parseInt(e.dataset.index);let a=0,n=!1,l={x:0,y:0};e.addEventListener("click",e=>{dragState.isDragging||handlePanelClick(t)}),e.addEventListener("mousedown",e=>{handleDragStart(t,e)}),e.addEventListener("touchstart",e=>{a=Date.now(),n=!1,l.x=e.touches[0].clientX,l.y=e.touches[0].clientY,handleDragStart(t,e)},{passive:!1}),e.addEventListener("touchmove",e=>{const t=Math.abs(e.touches[0].clientX-l.x),a=Math.abs(e.touches[0].clientY-l.y);(t>5||a>5)&&(n=!0)},{passive:!0}),e.addEventListener("touchend",e=>{const l=Date.now()-a;!n&&l<300&&!dragState.hasMovedEnough&&(e.preventDefault(),dragState.isDragging=!1,dragState.draggedIndex=null,dragState.draggedValue=null,handlePanelClick(t))})})}document.getElementById("add-button").addEventListener("click",handleAddButton),document.addEventListener("mousemove",handleDragMove),document.addEventListener("mouseup",handleDragEnd),document.addEventListener("touchmove",handleDragMove,{passive:!1}),document.addEventListener("touchend",handleDragEnd,{passive:!1});let dragState={isDragging:!1,draggedIndex:null,draggedValue:null,ghostElement:null,startX:0,startY:0,hasMovedEnough:!1};function handleDragStart(e,t){gameState.isRefilling||null!==gameState.grid[e]&&(isPetrified(e)||(t.preventDefault(),dragState.isDragging=!0,dragState.draggedIndex=e,dragState.draggedValue=gameState.grid[e],dragState.hasMovedEnough=!1,dragState.startX=t.clientX||t.touches&&t.touches[0].clientX,dragState.startY=t.clientY||t.touches&&t.touches[0].clientY))}function handleDragMove(e){if(!dragState.isDragging)return;e.preventDefault();const t=e.clientX||e.touches&&e.touches[0].clientX,a=e.clientY||e.touches&&e.touches[0].clientY;if(dragState.hasMovedEnough)updateDragGhost(e);else{const n=t-dragState.startX,l=a-dragState.startY;Math.sqrt(n*n+l*l)>=10&&(dragState.hasMovedEnough=!0,createDragGhost(e))}}function handleDragEnd(e){if(!dragState.isDragging)return;e.preventDefault();const t=getDropTarget(e);null!==t&&t!==dragState.draggedIndex&&performOrOperation(dragState.draggedIndex,t),removeDragGhost(),dragState.isDragging=!1,dragState.draggedIndex=null,dragState.draggedValue=null,dragState.hasMovedEnough=!1,dragState.startX=0,dragState.startY=0}function createDragGhost(e){const t=createPanelElement(dragState.draggedValue);t.id="drag-ghost",t.style.position="fixed",t.style.width="78px",t.style.transform="scale(1.3)",t.style.pointerEvents="none",t.style.opacity="0.7",t.style.zIndex="1000",document.body.appendChild(t),dragState.ghostElement=t,updateDragGhost(e)}function updateDragGhost(e){if(!dragState.ghostElement)return;const t=e.clientX||e.touches&&e.touches[0].clientX,a=e.clientY||e.touches&&e.touches[0].clientY;void 0!==t&&void 0!==a&&(dragState.ghostElement.style.left=t-39+"px",dragState.ghostElement.style.top=a-56+"px")}function removeDragGhost(){dragState.ghostElement&&(dragState.ghostElement.remove(),dragState.ghostElement=null)}function getDropTarget(e){const t=e.clientX||e.changedTouches&&e.changedTouches[0].clientX,a=e.clientY||e.changedTouches&&e.changedTouches[0].clientY;if(void 0===t||void 0===a)return null;const n=document.elementFromPoint(t,a),l=n?.closest(".grid-cell");return l&&l.dataset.index?parseInt(l.dataset.index):null}function performOrOperation(e,t){if(isPetrified(t))return void renderGrid();const a=gameState.grid[e],n=gameState.grid[t];if(null===n)gameState.grid[t]=a,gameState.grid[e]=null;else{const l=orOperation(a,n);gameState.grid[t]=l,gameState.grid[e]=null}renderGrid(),checkTargetMatch(t),checkAndPetrifyEight(t),checkAndRefillGrid()}function splitSegments(e,t){const a=[];for(let t=0;t<7;t++)e&1<<t&&a.push(t);if(a.length<t)return[e];const n=Array(t).fill(0).map(()=>[]);for(let e=0;e<t;e++){const t=Math.floor(Math.random()*a.length);n[e].push(a.splice(t,1)[0])}return a.forEach(e=>{const a=Math.floor(Math.random()*t);n[a].push(e)}),n.map(e=>{let t=0;return e.forEach(e=>{t|=1<<e}),t})}const testPanelSplit=DIGITS[8],split2=splitSegments(testPanelSplit,2);split2.forEach((e,t)=>{});const split3=splitSegments(testPanelSplit,3);function applyPoolOperation(e,t){let a=[];switch(t){case"a":a=[notOperation(e)];break;case"b":a=splitSegments(e,2);break;case"c":a=splitSegments(e,3);break;case"d":a=splitSegments(notOperation(e),2);break;case"e":a=splitSegments(notOperation(e),3);break;case"f":a=splitSegments(e,2).map(e=>Math.random()<.5?notOperation(e):e);break;case"g":a=splitSegments(e,3).map(e=>Math.random()<.5?notOperation(e):e);break;default:a=[e]}return a}split3.forEach((e,t)=>{});const testOpsPanel=DIGITS[2];function getPanelFromPool(){return 0===gameState.panelPool.length?generateRandomPanel():gameState.panelPool.shift()}function generateRandomPanel(){for(let e=0;e<100;e++){const e=Math.floor(6*Math.random())+1;let t=0;const a=new Set;for(;a.size<e;){const e=Math.floor(7*Math.random());a.add(e)}a.forEach(e=>{t|=1<<e});const n=gameState.targetPanels.includes(t),l=gameState.targetPanels.includes(notOperation(t));if(!n&&!l)return t}return 18}function generatePool(e){let t=[];gameState.targetPanels.forEach((a,n)=>{if(gameState.completedTargets[n])return;let l=[],r=0;for(;;){l=applyPoolOperation(a,e[Math.floor(Math.random()*e.length)]),r++;!e.includes("a")&&gameState.level>=5&&(l=l.map(e=>gameState.targetPanels.includes(notOperation(e))?generateRandomPanel():e));if(!l.some(e=>gameState.targetPanels.includes(e)))break;if(r>=100)break}t.push(...l)});const a=LEVELS.find(e=>e.levelNumber===gameState.level);return!1!==a?.shufflePool&&shuffleArray(t),t}function shuffleArray(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}}function regeneratePool(){const e=LEVELS.find(e=>e.levelNumber===gameState.level);if(!e)return;const t=e.allowedOperations;gameState.panelPool=generatePool(t)}function startTimer(){0!==gameState.timerDuration&&(stopTimer(),gameState.timerRemaining=gameState.timerDuration,updateTimerBar(),gameState.timerInterval=setInterval(()=>{gameState.timerRemaining-=100,updateTimerBar(),gameState.timerRemaining<=0&&(handleAddButton(),startTimer())},100))}function stopTimer(){gameState.timerInterval&&(clearInterval(gameState.timerInterval),gameState.timerInterval=null)}function pauseTimer(){gameState.timerInterval&&(clearInterval(gameState.timerInterval),gameState.timerInterval=null)}function resumeTimer(){0!==gameState.timerDuration&&(gameState.timerInterval||(gameState.timerInterval=setInterval(()=>{gameState.timerRemaining-=100,updateTimerBar(),gameState.timerRemaining<=0&&(handleAddButton(),startTimer())},100)))}function updateTimerBar(){const e=(gameState.timerDuration-gameState.timerRemaining)/gameState.timerDuration*100;document.getElementById("add-button").style.setProperty("--timer-width",e+"%")}function resetTimer(){startTimer()}["a","b","c","d","e"].forEach(e=>{applyPoolOperation(testOpsPanel,e)});const pauseButton=document.getElementById("pause-button"),pauseOverlay=document.getElementById("pause-overlay");pauseOverlay.addEventListener("click",e=>{if(Date.now()<pauseUnlockTime)return;const t=pauseOverlay.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top;a<=t.width/4&&n<=t.height/4?showHelpOverlay("pause-overlay"):a>=3*t.width/4&&n<=t.height/4?showNewGameOverlay("pause-overlay"):(pauseOverlay.style.display="none",resumeTimer())});let pauseUnlockTime=0;function showGameOverOverlay(){removeDragGhost(),dragState.isDragging=!1,dragState.draggedIndex=null,dragState.draggedValue=null,dragState.hasMovedEnough=!1,clearSave();const e=LEVELS.find(e=>e.levelNumber===gameState.level),t=e?e.displayName:gameState.level.toString();document.getElementById("year-display").textContent=t,stopTimer(),gameState.introInterval&&(clearInterval(gameState.introInterval),gameState.introInterval=null),gameState.refillInterval&&(clearInterval(gameState.refillInterval),gameState.refillInterval=null),gameState.grid=Array(25).fill(null),gameState.completedTargets=[!1,!1,!1,!1],gameState.petrifiedPositions=[],gameState.panelPool=[],gameState.isIntroSequence=!1,gameState.isRefilling=!1,gameState.level=1,initGrid(),renderGrid();document.getElementById("gameover-overlay").style.display="flex",gameoverUnlockTime=Date.now()+1e3}pauseButton.addEventListener("click",()=>{pauseTimer(),pauseOverlay.style.display="flex",pauseUnlockTime=Date.now()+300});let gameoverUnlockTime=0;const gameoverOverlay=document.getElementById("gameover-overlay");function showVictoryOverlay(){removeDragGhost(),dragState.isDragging=!1,dragState.draggedIndex=null,dragState.draggedValue=null,dragState.hasMovedEnough=!1,clearSave(),stopTimer(),gameState.introInterval&&(clearInterval(gameState.introInterval),gameState.introInterval=null),gameState.refillInterval&&(clearInterval(gameState.refillInterval),gameState.refillInterval=null),gameState.grid=Array(25).fill(null),gameState.completedTargets=[!1,!1,!1,!1],gameState.petrifiedPositions=[],gameState.panelPool=[],gameState.isIntroSequence=!1,gameState.isRefilling=!1,gameState.level=1,initGrid(),renderGrid();document.getElementById("victory-overlay").style.display="flex",victoryUnlockTime=Date.now()+1e3}gameoverOverlay.addEventListener("click",()=>{Date.now()<gameoverUnlockTime||showDifficultyOverlay("gameover-overlay")});let victoryUnlockTime=0,difficultyUnlockTime=0;function showDifficultyOverlay(e){e&&(document.getElementById(e).style.display="none");document.getElementById("difficulty-overlay").style.display="flex",difficultyUnlockTime=Date.now()+500}const difficultyOverlay=document.getElementById("difficulty-overlay");difficultyOverlay.addEventListener("click",e=>{if(Date.now()<difficultyUnlockTime)return;const t=difficultyOverlay.getBoundingClientRect(),a=(e.clientY-t.top)/t.height;a>=.25&&a<.5?(difficultyOverlay.style.display="none",initLevel(1)):a>=.5&&a<.75&&(difficultyOverlay.style.display="none",initLevel(12))});const victoryOverlay=document.getElementById("victory-overlay");function showHelpOverlay(e){previousOverlay=e,document.getElementById(e).style.display="none";document.getElementById("help-overlay").style.display="flex",helpUnlockTime=Date.now()+300}victoryOverlay.addEventListener("click",()=>{if(Date.now()<victoryUnlockTime)return;victoryOverlay.style.display="none";document.getElementById("intro-overlay").style.display="flex",introUnlockTime=Date.now()+300});let helpUnlockTime=0;const helpOverlay=document.getElementById("help-overlay");function showNewGameOverlay(e){previousOverlay=e,document.getElementById(e).style.display="none";document.getElementById("newgame-overlay").style.display="flex",newgameUnlockTime=Date.now()+500}helpOverlay.addEventListener("click",()=>{if(!(Date.now()<helpUnlockTime)&&(helpOverlay.style.display="none",previousOverlay)){document.getElementById(previousOverlay).style.display="flex","intro-overlay"===previousOverlay?introUnlockTime=Date.now()+300:"load-overlay"===previousOverlay?loadUnlockTime=Date.now()+300:"pause-overlay"===previousOverlay&&(pauseUnlockTime=Date.now()+300)}});let newgameUnlockTime=0;const newgameOverlay=document.getElementById("newgame-overlay");newgameOverlay.addEventListener("click",e=>{if(Date.now()<newgameUnlockTime)return;const t=newgameOverlay.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top;if(n<t.height/4*3&&n>=t.height/2)if(a<=t.width/2)clearSave(),gameState.petrifiedPositions=[],newgameOverlay.style.display="none",tutorials.forEach(e=>document.getElementById(e.elementId).style.display="none"),initGrid(),showDifficultyOverlay(null);else if(newgameOverlay.style.display="none",previousOverlay){document.getElementById(previousOverlay).style.display="flex","load-overlay"===previousOverlay?loadUnlockTime=Date.now()+300:"pause-overlay"===previousOverlay&&(pauseUnlockTime=Date.now()+300)}});let tutorialUnlockTime=0;function showTutorial(e){if(isTutorialSeen(e))return;let t;"tut04"===e&&pauseTimer(),"tut01"===e?t="tut01-merge":"tut02"===e?t="tut02-invert":"tut03"===e?t="tut03-add":"tut04"===e&&(t="tut04-shape8");const a=document.getElementById(t);a&&(a.style.display="flex",tutorialUnlockTime=Date.now()+1e3)}const tutorials=[{id:"tut01",elementId:"tut01-merge"},{id:"tut02",elementId:"tut02-invert"},{id:"tut03",elementId:"tut03-add"},{id:"tut04",elementId:"tut04-shape8"}];tutorials.forEach(e=>{const t=document.getElementById(e.elementId);t&&t.addEventListener("click",()=>{Date.now()<tutorialUnlockTime||(markTutorialSeen(e.id),t.style.display="none","tut03"===e.id&&(document.getElementById("add-button").style.visibility="visible"),"tut04"===e.id&&resumeTimer())})});const loadOverlay=document.getElementById("load-overlay");loadOverlay.addEventListener("click",e=>{if(Date.now()<loadUnlockTime)return;const t=loadOverlay.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top;a<=t.width/4&&n<=t.height/4?showHelpOverlay("load-overlay"):a>=3*t.width/4&&n<=t.height/4?showNewGameOverlay("load-overlay"):(loadOverlay.style.display="none",initLevel(loadedLevel))});let introUnlockTime=0;const introOverlay=document.getElementById("intro-overlay");introOverlay.addEventListener("click",e=>{if(Date.now()<introUnlockTime)return;const t=introOverlay.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top;a<=t.width/4&&n<=t.height/4?showHelpOverlay("intro-overlay"):isTutorialSeen("tut01")?showDifficultyOverlay("intro-overlay"):(introOverlay.style.display="none",initLevel(1))}),document.addEventListener("visibilitychange",()=>{if(document.hidden){removeDragGhost(),dragState.isDragging=!1,dragState.draggedIndex=null,dragState.draggedValue=null,dragState.hasMovedEnough=!1,pauseTimer();document.getElementById("pause-overlay").style.display="flex",pauseUnlockTime=Date.now()+300}});